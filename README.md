# XML Template Field Replacer

Набор утилит для автоматической замены префиксов полей в XML-шаблонах Word, используемых в системах документооборота.

## Возможности

- Автоматическое обнаружение полей в фигурных скобках `{...}`
- Обработка логических конструкций (`цикл()`, `выбор()`, `если()`)
- Одновременная замена текстовых и Base64-представлений полей
- Приоритетная замена (от длинных конструкций к коротким)
- Валидация результатов замены
- Гибкая конфигурация через JSON-файл

## Структура проекта

```
project/
├── config.json          # Общий конфигурационный файл
├── analyzer.js          # Утилита 1: Анализ XML и извлечение полей
├── generator.js         # Утилита 2: Генерация карты замен
├── replacer.js          # Утилита 3: Применение замен к XML
├── IN/                  # Входные файлы
│   └── template.xml     # Исходный XML-шаблон
└── OUT/                 # Выходные файлы
    ├── unique_names.json     # Уникальные имена полей
    ├── replacement_map.json  # Карта замен
    └── output.xml           # Обработанный XML
```

## Установка и требования

### Требования
- Node.js 14+
- 100+ МБ свободной памяти (для работы с большими XML-файлами)

### Установка
```bash
git clone <repository-url>
cd xml-template-replacer
```

## Использование

### 1. Настройка конфигурации

Отредактируйте `config.json`:

```json
{
  "analyzer": {
    "inputFile": "IN/template.xml",
    "outputFile": "OUT/unique_names.json",
    "originalPrefix": "автомобильПострадавшего.",
    "cleanLogicalConstructions": true,
    "sortByLength": true
  },
  "generator": {
    "inputFile": "OUT/unique_names.json",
    "outputFile": "OUT/replacement_map.json",
    "newPrefix": "арендованноеТс.",
    "encoding": "utf8"
  },
  "replacer": {
    "inputFile": "IN/template.xml",
    "outputFile": "OUT/output.xml",
    "replacementMapFile": "OUT/replacement_map.json"
  }
}
```

### 2. Запуск утилит

```bash
# Шаг 1: Анализ XML и извлечение полей
node analyzer.js

# Шаг 2: Генерация карты замен
node generator.js

# Шаг 3: Применение замен
node replacer.js
```

### Использование с кастомным конфигом
```bash
node analyzer.js custom-config.json
node generator.js custom-config.json
node replacer.js custom-config.json
```

## Пример рабочего процесса

### Исходные данные
XML содержит поля типа:
```xml
{автомобильПострадавшего.страховаяКомпания}
{форматВалюты(автомобильПострадавшего.сумма, ФорматВалюты.Краткий)}
{цикл(документы из автомобильПострадавшего.документы)}
```

### После обработки
```xml
{арендованноеТс.страховаяКомпания}
{форматВалюты(арендованноеТс.сумма, ФорматВалюты.Краткий)}
{цикл(документы из арендованноеТс.документы)}
```

## Поддерживаемые конструкции

### Логические операторы
- `цикл(документы из поле)` → извлекается `поле`
- `выбор(поле)` → извлекается `поле`
- `если(поле)` → извлекается `поле`

### Сложные выражения
- `форматВалюты(поле, параметры)`
- Составные имена: `префикс.поле.субполе`
- Вложенные вызовы функций

## Производительность

- Обрабатывает файлы размером до 12+ МБ
- 2700+ замен за несколько секунд
- 90+ уникальных имен полей
- Автоматическая валидация Base64-совпадений

## Отладка и логирование

Каждая утилита предоставляет детальное логирование:

```bash
node analyzer.js
# Найдено 156 фрагментов в фигурных скобках
# Отфильтровано 90 фрагментов с целевым префиксом
# Анализ завершен!
```

## Особенности безопасности

- Валидация входных файлов
- Проверка целостности Base64-кодировок
- Резервное копирование не требуется (исходные файлы не изменяются)

## Разработчик

Alexander Kuzikov

## Лицензия

Apache-2.0 License

## Вклад в проект

1. Форкните репозиторий
2. Создайте feature-ветку (`git checkout -b feature/amazing-feature`)
3. Закоммитьте изменения (`git commit -m 'Add amazing feature'`)
4. Запушьте ветку (`git push origin feature/amazing-feature`)
5. Откройте Pull Request

## Поддержка

При возникновении проблем создавайте issue в репозитории проекта.

---

**Примечание**: Перед использованием в production рекомендуется тщательное тестирование на ваших конкретных шаблонах.
